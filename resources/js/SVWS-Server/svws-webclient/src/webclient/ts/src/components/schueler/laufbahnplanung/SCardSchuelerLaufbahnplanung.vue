<template>
	<svws-ui-content-card>
		<div class="flex flex-row gap-4">
			<div class="-my-2 flex-none sm:-mx-6 lg:-mx-8">
				<div class="inline-block py-2 align-middle sm:px-6 lg:px-8">
					<div class="overflow-hidden rounded-lg shadow">
						<table class="border-collapse text-sm">
							<thead :class="{'bg-slate-100': !manuell, 'bg-red-400': manuell}">
								<tr>
									<td class="border border-[#7f7f7f]/20 text-center" colspan="3">
										Fach
									</td>
									<td class="border border-[#7f7f7f]/20 text-center" colspan="2">
										Sprachen
									</td>
									<td class="border border-[#7f7f7f]/20 text-center" colspan="2">
										EF
									</td>
									<td class="border border-[#7f7f7f]/20 text-center" colspan="4">
										Qualifikationsphase
									</td>
									<td
										class="border border-[#7f7f7f]/20 px-2 text-center"
										rowspan="2"
									>
										Abitur<br />-fach
									</td>
								</tr>
								<tr>
									<td class="border border-[#7f7f7f]/20 px-2 text-center">
										Kürzel
									</td>
									<td class="border border-[#7f7f7f]/20 text-center">
										Bezeichnung
									</td>
									<td class="border border-[#7f7f7f]/20 text-center">WStd.</td>
									<td class="border border-[#7f7f7f]/20 text-center">Folge</td>
									<td class="border border-[#7f7f7f]/20 text-center">ab Jg</td>
									<td class="border border-[#7f7f7f]/20 text-center">EF.1</td>
									<td class="border border-[#7f7f7f]/20 text-center">EF.2</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q1.1</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q1.2</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q2.1</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q2.2</td>
								</tr>
							</thead>
							<tr v-for="row in rows" :key="row.id">
								<s-row-lupo :fach="row"></s-row-lupo>
							</tr>
							<thead class="bg-slate-100">
								<tr>
									<td
										class="border border-[#7f7f7f]/20 text-center"
										colspan="5"
									></td>
									<td class="border border-[#7f7f7f]/20 text-center">EF.1</td>
									<td class="border border-[#7f7f7f]/20 text-center">EF.2</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q1.1</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q1.2</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q2.1</td>
									<td class="border border-[#7f7f7f]/20 text-center">Q2.2</td>
									<td class="border border-[#7f7f7f]/20 text-center"></td>
								</tr>
							</thead>
							<tr>
								<td
									class="border border-[#7f7f7f]/20 bg-slate-100 text-center"
									colspan="5"
								>
									Anzahl Kurse
								</td>
								<td
									v-for="(jahrgang, i) in kurszahlen"
									:key="i"
									class="border border-[#7f7f7f]/20 text-center"
									:class="{
										'bg-yellow-400': jahrgang < 10,
										'bg-green-300': jahrgang > 9,
										'bg-green-700': jahrgang > 11
									}"
								>
									{{ jahrgang }}
								</td>
								<td
									class="border border-[#7f7f7f]/20 bg-slate-100 text-center"
									:class="{
										'bg-red-400': kurse_summe < 30,
										'bg-yellow-400':
											kurse_summe >= 31 &&
											kurse_summe <= 32,
										'bg-green-300':
											kurse_summe > 32 &&
											kurse_summe < 37,
										'bg-green-700': kurse_summe > 36
									}"
								>
									{{ kurse_summe }}
								</td>
							</tr>
							<tr>
								<td
									class="border border-[#7f7f7f]/20 bg-slate-100 text-center"
									colspan="5"
								>
									Wochenstunden
								</td>
								<td
									v-for="(jahrgang, i) in wochenstunden"
									:key="i"
									class="border border-[#7f7f7f]/20 text-center"
									:class="{
										'bg-red-400': jahrgang < 30,
										'bg-yellow-400':
											jahrgang >= 31 && jahrgang <= 32,
										'bg-green-300':
											jahrgang > 32 && jahrgang < 37,
										'bg-green-700': jahrgang > 36
									}"
								>
									{{ jahrgang }}
								</td>
								<td
									class="border border-[#7f7f7f]/20 bg-slate-100 text-center"
									:class="{
										'bg-red-400': wst_summe < 100,
										'bg-yellow-400':
											wst_summe >= 100 && wst_summe < 107,
										'bg-green-700': wst_summe >= 107
									}"
								>
									{{ wst_summe }}
								</td>
							</tr>
							<tr>
								<td
									class="border border-[#7f7f7f]/20 bg-slate-100 text-center"
									colspan="5"
								>
									Durchschnitt
								</td>
								<td
									colspan="2"
									class="border border-[#7f7f7f]/20 text-center"
									:class="{
										'bg-red-400': wst_d_ef < 34,
										'bg-green-300':
											wst_d_ef >= 34 && wst_d_ef < 37,
										'bg-green-700': wst_d_ef >= 37
									}"
								>
									{{ wst_d_ef }}
								</td>
								<td
									colspan="4"
									class="border border-[#7f7f7f]/20 bg-slate-100 text-center"
									:class="{
										'bg-red-400': wst_d_q < 34,
										'bg-green-300':
											wst_d_q >= 34 && wst_d_q < 37,
										'bg-green-700': wst_d_q >= 37
									}"
								>
									{{ wst_d_q }}
								</td>
								<td class="border border-[#7f7f7f]/20 bg-slate-100"></td>
							</tr>
						</table>
					</div>
					<div class="flex justify-between">

						<svws-ui-button class="my-4" @click.prevent="download_file"
						>Wahlbogen herunterladen</svws-ui-button
					>
					<span><svws-ui-button :type="manuell ? 'danger':'primary'" class="my-4" @click="manu">Manuellen Modus {{manuell?"de":""}}aktivieren</svws-ui-button></span>
					</div>
				</div>
			</div>
			<div class="-my-2 flex-grow print:hidden sm:-mx-6 lg:-mx-8">
				<div class="inline-block py-2 align-middle sm:px-6 lg:px-8">
					<div class="overflow-hidden rounded-lg shadow">
						<table class="border-collapse text-sm">
							<thead class="bg-slate-100">
								<tr>
									<td class="px-2">Belegprüfung</td>
								</tr>
							</thead>
							<tbody>
								<tr
									class="border border-[#7f7f7f]/20 text-left"
								>
									<td class="px-2">
										<div class="flex gap-4">
											<div
												class="form-check form-check-inline cursor-pointer"
											>
												<input
													id="ef"
													v-model="belegpruefungsart"
													class="bg-text-center float-left mt-[0.15rem] mr-2 h-4 w-4 cursor-pointer rounded-full border border-gray-300 bg-white bg-contain checked:border-slate-100 checked:bg-slate-100 focus:outline-none"
													type="radio"
													name="inlineRadioOptions"
													:value="ef1"
												/>
												<label
													class="form-check-label inline-block cursor-pointer"
													for="ef"
													>EF 1</label
												>
											</div>
											<div
												class="form-check form-check-inline cursor-pointer"
											>
												<input
													id="gesamt"
													v-model="belegpruefungsart"
													class="bg-text-center float-left mt-[0.15rem] mr-2 h-4 w-4 cursor-pointer rounded-full border border-gray-300 bg-white bg-contain checked:border-slate-100 checked:bg-slate-100 focus:outline-none"
													type="radio"
													name="inlineRadioOptions"
													:value="gesamt"
												/>
												<label
													class="form-check-label inline-block cursor-pointer"
													for="gesamt"
													>Gesamt</label
												>
											</div>
										</div>
									</td>
								</tr>
							</tbody>
							<thead class="bg-slate-100">
								<tr>
									<td class="px-2">
										Laufbahnfehler
										<svws-ui-badge
											v-if="belegungsfehler.length"
											variant="error"
											size="tiny"
										>
											{{ belegungsfehler.length }}
										</svws-ui-badge>
									</td>
								</tr>
							</thead>
							<tbody>
								<tr
									v-for="fehler in belegungsfehler"
									:key="fehler.code.toString()"
									class="border border-[#7f7f7f]/20 text-left"
								>
									<td
										v-if="belegungsfehler.length"
										class="px-2"
									>
										{{ fehler.beschreibung }}
									</td>
								</tr>
								<tr v-if="!belegungsfehler.length">
									<td class="px-2">Keine</td>
								</tr>
							</tbody>
							<thead class="bg-slate-100">
								<tr>
									<td class="px-2">
										Informationen zur Laufbahn
									</td>
								</tr>
							</thead>
							<tbody>
								<tr
									v-for="fehler in belegungsHinweise"
									:key="fehler.code.toString()"
									class="border border-[#7f7f7f]/20 text-left"
								>
									<td class="px-2">
										{{ fehler.beschreibung }}
									</td>
								</tr>
								<tr v-if="!belegungsHinweise.length">
									<td class="px-2">Keine</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="am:px-6 py-2 lg:px-8">
					<svws-ui-text-input
						v-model="inputBeratungsdatum"
						type="date"
						placeholder="Beratungsdatum"
					/>
				</div>
				<div class="am:px-6 py-2 lg:px-8">
					<svws-ui-textarea-input placeholder="Kommentar"></svws-ui-textarea-input>
				</div>
				<div v-if="app.dataGostLaufbahndaten?.daten?.sprachendaten.pruefungen.size()" class="inline-block py-2 align-middle sm:px-6 lg:px-8 w-full">
					<div class="overflow-hidden rounded-lg shadow">
						<table class="border-collapse text-sm w-full">
							<thead class="bg-slate-100">
								<tr><td colspan="5" class="px-2">Sprachprüfungen</td></tr>
								<tr>
									<td class="px-2">Sprache</td>
									<td class="px-2">Typ</td>
									<td class="px-2">Niveau</td>
									<td class="px-2">Ersetzt</td>
									<td class="px-2 text-center">Note</td>
								</tr>
							</thead>
							<tbody>
						<tr v-for="pruefung in app.dataGostLaufbahndaten?.daten?.sprachendaten.pruefungen" :key="pruefung.sprache" class="border bottom-1  border-[#7f7f7f]/20">
							<td class="px-2">{{pruefung.sprache}}</td>
							<td class="px-2">{{pruefung.istHSUPruefung ? "HSU":''}}{{pruefung.istFeststellungspruefung ? 'SFP':''}}</td>
							<td class="px-2">{{Sprachpruefungniveau.getByID(pruefung.anspruchsniveauId || null)?.beschreibung}}</td>
							<td class="px-2">{{pruefung.istHKUPruefung?'–':''}}{{pruefung.kannErstePflichtfremdspracheErsetzen ? 'Erste Fremdsprache':''}}{{pruefung.kannZweitePflichtfremdspracheErsetzen ? 'Zweite Fremdsprache':''}}{{pruefung.kannWahlpflichtfremdspracheErsetzen ? 'Wahlpflichtfremdsprache':''}}</td>
							<td class="text-center">{{pruefung.note}}</td>
						</tr>
							</tbody>
					</table>
					</div>
				</div>
			</div>
		</div>
	</svws-ui-content-card>
</template>

<script setup lang="ts">
	import { computed, ComputedRef, ref } from "vue";

	import {
		GostBelegpruefungErgebnisFehler,
		GostBelegpruefungsArt,
		GostBelegungsfehlerArt,
		GostFach,
		Sprachpruefungniveau
	} from "@svws-nrw/svws-core-ts";
	import { App } from "~/apps/BaseApp";
	import { injectMainApp, Main } from "~/apps/Main";
	import { DataSchuelerLaufbahnplanung } from "~/apps/schueler/DataSchuelerLaufbahnplanung";

	const main: Main = injectMainApp();
	const app = main.apps.schueler;
	const ef1: GostBelegpruefungsArt = GostBelegpruefungsArt.EF1;
	const gesamt: GostBelegpruefungsArt = GostBelegpruefungsArt.GESAMT;

	const manuell = ref(false)

	function manu() {manuell.value = manuell.value ? false:true; data.value.manuelle_eingabe = manuell.value}

	const data: ComputedRef<DataSchuelerLaufbahnplanung> = computed(() => {
		return app.dataGostLaufbahndaten || new DataSchuelerLaufbahnplanung();
	});

	const id = computed<number | undefined>(() => {
		return app.auswahl.ausgewaehlt?.id;
	});

	const rows = computed<GostFach[]>(() => {
		return data.value.gostFaecher;
	});

	const kurszahlen = computed<number[]>(() => {
		return data.value.anrechenbare_kurszahlen;
	});

	const kurse_summe = computed<number>(() => {
		//TODO korrigieren
		return data.value.anrechenbare_kurszahlen.reduce((p, c) => p + c, 0);
	});

	const wochenstunden = computed<number[]>(() => {
		return data.value.wochenstunden;
	});

	const wst_summe = computed<number>(() => {
		return wochenstunden.value.reduce((p, c) => p + c, 0) / 2;
	});

	const wst_d_ef = computed<number>(() => {
		return (wochenstunden.value[0] + wochenstunden.value[1]) / 2;
	});

	const wst_d_q = computed<number>(() => {
		const [e, f, ...q] = wochenstunden.value;
		void e, f;
		return q.reduce((p, c) => p + c, 0) / 4;
	});

	const isNurEF1Selected = computed<boolean>(() => {
		return (
			data.value.gostAktuelleBelegpruefungsart ===
			GostBelegpruefungsArt.EF1
		);
	});

	const isGesamtSelected = computed<boolean>(() => {
		return (
			data.value.gostAktuelleBelegpruefungsart ===
			GostBelegpruefungsArt.GESAMT
		);
	});

	const belegungsfehlerAlle = computed<GostBelegpruefungErgebnisFehler[]>(
		() => {
			return data.value.gostBelegpruefungsErgebnis.fehlercodes.toArray(
				new Array<GostBelegpruefungErgebnisFehler>()
			);
		}
	);

	const belegungsfehler = computed<GostBelegpruefungErgebnisFehler[]>(() => {
		return belegungsfehlerAlle.value.filter(
			fehler =>
				!!fehler &&
				(GostBelegungsfehlerArt.fromKuerzel(fehler.art) ===
					GostBelegungsfehlerArt.BELEGUNG ||
					GostBelegungsfehlerArt.fromKuerzel(fehler.art) ===
						GostBelegungsfehlerArt.SCHRIFTLICHKEIT)
		);
	});

	const belegungsHinweise = computed<GostBelegpruefungErgebnisFehler[]>(
		() => {
			return belegungsfehlerAlle.value.filter(
				fehler =>
					!!fehler &&
					GostBelegungsfehlerArt.fromKuerzel(fehler.art) ===
						GostBelegungsfehlerArt.HINWEIS
			);
		}
	);

	const belegpruefungsart = computed<GostBelegpruefungsArt>({
		get(): GostBelegpruefungsArt {
			return data.value.gostAktuelleBelegpruefungsart;
		},
		set(value: GostBelegpruefungsArt) {
			data.value.gostAktuelleBelegpruefungsart = value;
		}
	});

	const inputBeratungsdatum = computed<string>({
		get(): string {
			return ""; //this.app.stammdaten.daten.geburtsdatum;
		},
		set(val: string) {
			void val;
			//this.app.stammdaten.patch({ geburtsdatum: val });
		}
	});

	function download_file() {
		const id = app.stammdaten.daten?.id;
		if (!id) return;
		App.api
			.getGostSchuelerPDFWahlbogen(App.schema, id)
			.then(blob => {
				const link = document.createElement("a");
				link.href = URL.createObjectURL(blob);
				link.download = "Wahlbogen.pdf";
				link.target = "_blank";
				link.click();
				URL.revokeObjectURL(link.href);
			})
			.catch(console.error);
	}
</script>
